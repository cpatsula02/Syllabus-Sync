{% extends "layout.html" %}

{% block title %}Document: {{ document.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .annotation-marker {
        background-color: rgba(255, 230, 0, 0.3);
        cursor: pointer;
        padding: 2px 0;
        position: relative;
    }
    
    .annotation-marker:hover {
        background-color: rgba(255, 230, 0, 0.5);
    }
    
    .document-content {
        position: relative;
        white-space: pre-wrap;
        line-height: 1.6;
        font-family: 'Arial', sans-serif;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fff;
        max-height: 75vh;
        overflow-y: auto;
    }
    
    .annotation-tooltip {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        z-index: 100;
        max-width: 300px;
    }
    
    .annotation-author {
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
    }
    
    .annotation-date {
        font-size: 0.85em;
        color: #6c757d;
        margin-bottom: 8px;
    }
    
    .chat-container {
        height: 300px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px 5px 0 0;
    }
    
    .chat-input-container {
        display: flex;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
    }
    
    .chat-input {
        flex-grow: 1;
        border: none;
        padding: 10px;
        outline: none;
    }
    
    .chat-send-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
    }
    
    .chat-message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
        position: relative;
    }
    
    .chat-message-self {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }
    
    .chat-message-other {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }
    
    .chat-username {
        font-size: 0.75em;
        font-weight: bold;
        margin-bottom: 3px;
    }
    
    .chat-timestamp {
        font-size: 0.7em;
        color: #6c757d;
        margin-top: 2px;
        text-align: right;
    }
    
    .collaborator-active {
        color: #28a745;
    }
    
    .user-presence-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .user-presence-online {
        background-color: #28a745;
    }
    
    .user-presence-offline {
        background-color: #dc3545;
    }
    
    .online-users-container {
        position: fixed;
        top: 70px;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        max-width: 200px;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<input type="hidden" id="document-id" value="{{ document_id }}">
<input type="hidden" id="current-user-id" value="{{ current_user.id }}">
<input type="hidden" id="current-username" value="{{ current_user.username }}">

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>{{ document.title }}</h2>
                <div>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
                    {% if current_user.id == document.owner_id %}
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shareModal">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <ul class="nav nav-tabs mb-3" id="documentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="document-tab" data-bs-toggle="tab" data-bs-target="#document-content" type="button" role="tab" aria-controls="document-content" aria-selected="true">Document</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-content" type="button" role="tab" aria-controls="analysis-content" aria-selected="false">Analysis Results</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="checklist-tab" data-bs-toggle="tab" data-bs-target="#checklist-content" type="button" role="tab" aria-controls="checklist-content" aria-selected="false">Checklist</button>
                </li>
            </ul>
            
            <div class="tab-content" id="documentTabsContent">
                <div class="tab-pane fade show active" id="document-content" role="tabpanel" aria-labelledby="document-tab">
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <button id="add-annotation-btn" class="btn btn-sm btn-success">
                            <i class="fas fa-comment"></i> Add Annotation
                        </button>
                        <span class="text-muted small">Select text to annotate</span>
                    </div>
                    
                    <div id="document-display" class="document-content">
                        {{ document.content_text|safe }}
                    </div>
                </div>
                
                <div class="tab-pane fade" id="analysis-content" role="tabpanel" aria-labelledby="analysis-tab">
                    {% if analysis_data %}
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Analysis Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <div class="display-4">{{ analysis_data.present_count }}</div>
                                        <p class="text-success">Items Present</p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="display-4">{{ analysis_data.missing_count }}</div>
                                        <p class="text-danger">Items Missing</p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="display-4">{{ analysis_data.total_count }}</div>
                                        <p class="text-muted">Total Items</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Detailed Results</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    {% for result in analysis_data.results %}
                                        <div class="list-group-item {% if result.is_grade_item %}list-group-item-info{% endif %}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1">{{ result.item }}</h6>
                                                <span class="badge {% if result.status == 'present' %}bg-success{% else %}bg-danger{% endif %}">
                                                    {{ result.status|capitalize }}
                                                </span>
                                            </div>
                                            <p class="mb-1">{{ result.explanation }}</p>
                                            <small class="text-muted">
                                                Confidence: {{ (result.confidence * 100)|int }}% | 
                                                Method: {{ result.method }}
                                            </small>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No analysis data available for this document.
                        </div>
                    {% endif %}
                </div>
                
                <div class="tab-pane fade" id="checklist-content" role="tabpanel" aria-labelledby="checklist-tab">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Checklist</h5>
                        </div>
                        <div class="card-body">
                            <pre>{{ document.checklist_text }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Collaborators</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush" id="collaborators-list">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ document.owner.username }} (Owner)
                            <span class="badge bg-primary">Owner</span>
                        </li>
                        
                        {% for collab in collaborators %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ collab.user.username }}
                                <div>
                                    <span class="badge bg-secondary">{{ collab.access_level|capitalize }}</span>
                                    {% if current_user.id == document.owner_id %}
                                        <form method="POST" action="{{ url_for('remove_collaborator', document_id=document.id, collab_id=collab.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                    
                    {% if current_user.id == document.owner_id %}
                        <div class="mt-3">
                            <form method="POST" action="{{ url_for('add_collaborator', document_id=document.id) }}">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" name="username" placeholder="Username" required>
                                    <select name="access_level" class="form-select">
                                        <option value="viewer">Viewer</option>
                                        <option value="annotator">Annotator</option>
                                        <option value="editor">Editor</option>
                                    </select>
                                    <button type="submit" class="btn btn-primary">Add</button>
                                </div>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Annotations</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush" id="annotations-list">
                        {% if annotations %}
                            {% for annotation in annotations %}
                                <li class="list-group-item annotation-list-item" data-id="{{ annotation.id }}" data-position="{{ annotation.position }}">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">{{ annotation.user.username }}</span>
                                        <small class="text-muted">{{ annotation.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <p class="mb-0">{{ annotation.text }}</p>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item">No annotations yet</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Live Chat</h5>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- Chat messages will be added here -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">
                            <button class="chat-send-btn" id="chat-send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Annotation Modal -->
<div class="modal fade" id="annotationModal" tabindex="-1" aria-labelledby="annotationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="annotationModalLabel">Add Annotation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="annotation-form">
                    <div class="mb-3">
                        <label for="annotation-text" class="form-label">Selected Text:</label>
                        <div id="selected-text" class="p-2 bg-light border rounded mb-2"></div>
                        <input type="hidden" id="position-data">
                    </div>
                    <div class="mb-3">
                        <label for="annotation-text" class="form-label">Your Annotation:</label>
                        <textarea class="form-control" id="annotation-text" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-annotation-btn">Save Annotation</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Document Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Share this document with other users by adding them as collaborators.</p>
                
                <form method="POST" action="{{ url_for('add_collaborator', document_id=document.id) }}">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="access_level" class="form-label">Access Level</label>
                        <select name="access_level" id="access_level" class="form-select">
                            <option value="viewer">Viewer (can only view)</option>
                            <option value="annotator">Annotator (can add annotations)</option>
                            <option value="editor">Editor (can add/edit annotations)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Collaborator</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="online-users-container" id="online-users">
    <h6>Online Users</h6>
    <ul class="list-group list-group-flush" id="online-users-list">
        <!-- Online users will be added here -->
    </ul>
</div>

<script>
    // Store document ID for later use
    const documentId = {{ document.id }};
    const currentUserId = {{ current_user.id }};
    const currentUsername = "{{ current_user.username }}";
    
    // Connect to Socket.IO
    const socket = io();
    let onlineUsers = new Set();
    
    // Join document room when connected
    socket.on('connect', function() {
        socket.emit('join_document', { document_id: documentId });
        
        // Add current user to online list
        addUserToOnlineList(currentUserId, currentUsername);
    });
    
    // Handle disconnect
    socket.on('disconnect', function() {
        console.log('Disconnected from server');
    });
    
    // Event when a user joins the document
    socket.on('user_joined', function(data) {
        console.log(`User ${data.username} joined`);
        addUserToOnlineList(data.user_id, data.username);
        
        // Add notification to chat
        addSystemMessage(`${data.username} joined the document`);
    });
    
    // Event when a user leaves the document
    socket.on('user_left', function(data) {
        console.log(`User ${data.username} left`);
        removeUserFromOnlineList(data.user_id);
        
        // Add notification to chat
        addSystemMessage(`${data.username} left the document`);
    });
    
    // Handle new annotations from other users
    socket.on('new_annotation', function(data) {
        console.log('New annotation received:', data);
        addAnnotationToList(data);
        highlightAnnotatedText(data);
    });
    
    // Handle updated annotations
    socket.on('annotation_updated', function(data) {
        console.log('Annotation updated:', data);
        updateAnnotationInList(data);
    });
    
    // Handle deleted annotations
    socket.on('annotation_deleted', function(data) {
        console.log('Annotation deleted:', data);
        removeAnnotationFromList(data.id);
        removeAnnotationHighlight(data.id);
    });
    
    // Handle chat messages
    socket.on('chat_message', function(data) {
        console.log('Chat message received:', data);
        addChatMessage(data, data.user_id === currentUserId);
    });
    
    // Function to add a user to the online list
    function addUserToOnlineList(userId, username) {
        if (onlineUsers.has(userId)) return;
        
        onlineUsers.add(userId);
        
        const userItem = document.createElement('li');
        userItem.className = 'list-group-item py-1';
        userItem.dataset.userId = userId;
        userItem.innerHTML = `
            <span class="user-presence-indicator user-presence-online"></span>
            ${username}
        `;
        
        document.getElementById('online-users-list').appendChild(userItem);
    }
    
    // Function to remove a user from the online list
    function removeUserFromOnlineList(userId) {
        if (!onlineUsers.has(userId)) return;
        
        onlineUsers.delete(userId);
        
        const userItem = document.querySelector(`#online-users-list li[data-user-id="${userId}"]`);
        if (userItem) {
            userItem.remove();
        }
    }
    
    // Function to add a system message to the chat
    function addSystemMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'text-center my-2';
        messageElement.innerHTML = `<small class="text-muted">${message}</small>`;
        
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Function to add a chat message to the chat window
    function addChatMessage(message, isSelf) {
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${isSelf ? 'chat-message-self' : 'chat-message-other'}`;
        messageElement.innerHTML = `
            ${!isSelf ? `<div class="chat-username">${message.username}</div>` : ''}
            <div>${message.message}</div>
            <div class="chat-timestamp">${formatTimestamp(message.timestamp)}</div>
        `;
        
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Function to format timestamp
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Function to add an annotation to the list
    function addAnnotationToList(annotation) {
        const annotationItem = document.createElement('li');
        annotationItem.className = 'list-group-item annotation-list-item';
        annotationItem.dataset.id = annotation.id;
        annotationItem.dataset.position = annotation.position;
        annotationItem.innerHTML = `
            <div class="d-flex justify-content-between">
                <span class="fw-bold">${annotation.username}</span>
                <small class="text-muted">${formatTimestamp(annotation.created_at)}</small>
            </div>
            <p class="mb-0">${annotation.text}</p>
        `;
        
        const annotationsList = document.getElementById('annotations-list');
        if (annotationsList.querySelector('li').textContent === 'No annotations yet') {
            annotationsList.innerHTML = '';
        }
        annotationsList.appendChild(annotationItem);
    }
    
    // Function to update an annotation in the list
    function updateAnnotationInList(annotation) {
        const annotationItem = document.querySelector(`.annotation-list-item[data-id="${annotation.id}"]`);
        if (annotationItem) {
            annotationItem.querySelector('p').textContent = annotation.text;
        }
    }
    
    // Function to remove an annotation from the list
    function removeAnnotationFromList(annotationId) {
        const annotationItem = document.querySelector(`.annotation-list-item[data-id="${annotationId}"]`);
        if (annotationItem) {
            annotationItem.remove();
            
            // If no annotations left, add 'No annotations yet' message
            const annotationsList = document.getElementById('annotations-list');
            if (annotationsList.children.length === 0) {
                annotationsList.innerHTML = '<li class="list-group-item">No annotations yet</li>';
            }
        }
    }
    
    // Function to highlight annotated text
    function highlightAnnotatedText(annotation) {
        // Implementation depends on how you're storing position information
        // This is a placeholder - you'll need to adapt this to your actual document structure
        try {
            const position = JSON.parse(annotation.position);
            // Example: position = { startNode: "p-3", startOffset: 10, endNode: "p-3", endOffset: 20 }
            
            // Placeholder implementation - you'll need to adapt this
            console.log('Highlighting annotation with position:', position);
        } catch (e) {
            console.error('Error parsing annotation position:', e);
        }
    }
    
    // Function to remove annotation highlight
    function removeAnnotationHighlight(annotationId) {
        const highlightElement = document.querySelector(`.annotation-marker[data-annotation-id="${annotationId}"]`);
        if (highlightElement) {
            // Get the text content
            const textContent = highlightElement.textContent;
            
            // Replace the highlight element with plain text
            highlightElement.parentNode.replaceChild(document.createTextNode(textContent), highlightElement);
        }
    }
    
    // Handle selection for annotations
    let currentSelection = null;
    
    document.getElementById('document-display').addEventListener('mouseup', function() {
        const selection = window.getSelection();
        if (selection.toString().trim().length > 0) {
            currentSelection = {
                text: selection.toString(),
                range: selection.getRangeAt(0),
                position: JSON.stringify({
                    startOffset: selection.getRangeAt(0).startOffset,
                    endOffset: selection.getRangeAt(0).endOffset,
                    // More sophisticated position tracking would be needed for production
                })
            };
            
            // Show add annotation button or open modal directly
            const addAnnotationBtn = document.getElementById('add-annotation-btn');
            addAnnotationBtn.classList.add('btn-pulse');  // Add a CSS class for highlighting
        } else {
            currentSelection = null;
            document.getElementById('add-annotation-btn').classList.remove('btn-pulse');
        }
    });
    
    // Handle clicking the add annotation button
    document.getElementById('add-annotation-btn').addEventListener('click', function() {
        if (currentSelection) {
            // Show the selected text in the modal
            document.getElementById('selected-text').textContent = currentSelection.text;
            document.getElementById('position-data').value = currentSelection.position;
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('annotationModal')).show();
        } else {
            alert('Please select text to annotate first.');
        }
    });
    
    // Handle saving an annotation
    document.getElementById('save-annotation-btn').addEventListener('click', function() {
        const text = document.getElementById('annotation-text').value.trim();
        const position = document.getElementById('position-data').value;
        
        if (!text) {
            alert('Please enter an annotation.');
            return;
        }
        
        // Send annotation to server
        fetch(`/document/${documentId}/add_annotation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                text: text,
                position: position
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('annotationModal')).hide();
            
            // Clear the form
            document.getElementById('annotation-text').value = '';
            
            // The server will emit a socket event that will update the UI
        })
        .catch(error => {
            console.error('Error adding annotation:', error);
            alert('Error adding annotation. Please try again.');
        });
    });
    
    // Handle annotation item clicks
    document.getElementById('annotations-list').addEventListener('click', function(e) {
        const annotationItem = e.target.closest('.annotation-list-item');
        if (annotationItem) {
            try {
                const position = JSON.parse(annotationItem.dataset.position);
                // Scroll to position or highlight it temporarily
                // This is a placeholder - implementation will depend on your document structure
                console.log('Clicked annotation with position:', position);
                
                // Example: scroll to position
                // This is simplified - you'll need to adapt it to your actual document structure
                if (position.startOffset !== undefined) {
                    // Placeholder logic - you'll need to find the actual element
                    document.getElementById('document-display').scrollTop = position.startOffset * 10;
                }
            } catch (e) {
                console.error('Error parsing annotation position:', e);
            }
        }
    });
    
    // Handle sending chat messages
    document.getElementById('chat-send-btn').addEventListener('click', function() {
        sendChatMessage();
    });
    
    document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
    
    function sendChatMessage() {
        const messageInput = document.getElementById('chat-input');
        const message = messageInput.value.trim();
        
        if (message) {
            socket.emit('new_chat_message', {
                document_id: documentId,
                message: message
            });
            
            messageInput.value = '';
        }
    }
    
    // Load existing chat messages when the page loads
    function loadExistingChatMessages() {
        // This would typically involve an AJAX call to your server
        // For this example, we'll just show a placeholder message
        addSystemMessage('Welcome to the collaboration chat');
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadExistingChatMessages();
        
        // Set up annotation highlighting
        const annotationItems = document.querySelectorAll('.annotation-list-item');
        annotationItems.forEach(item => {
            try {
                const position = JSON.parse(item.dataset.position);
                // Highlight this annotation in the document
                // Implementation depends on your document structure
            } catch (e) {
                console.error('Error parsing annotation position:', e);
            }
        });
    });
    
    // Clean up when leaving the page
    window.addEventListener('beforeunload', function() {
        socket.emit('leave_document', { document_id: documentId });
    });
</script>
{% endblock %}